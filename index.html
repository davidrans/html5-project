<!doctype html>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="./css/style.css">
	<script src="./js/mootools-core-1.4.5-full-nocompat-yc.js" type="text/javascript"></script>
	<script src="./js/mootools-more-1.4.0.1.js" type="text/javascript"></script>
	<script src="./js/Database.js" type="text/javascript"></script>
	<script src="./js/iFixitDevice.js" type="text/javascript"></script>
	<script>
		var db = new Database();
		db.create();
		
		var sortable, offset = 10, gear = [];
		
		var deviceRequest = new Request.JSONP({
			url: 'https://www.ifixit.com/api/1.0/topics/all',
			callbackKey: 'jsonp',
			data: {
				limit: 10,
				offset: 0
			},
			onComplete: function(data) {
				for( var i = 0; i < data.length; i++ )
				{
					if( gear.indexOf( data[i].topic ) === -1 )
					{
						var d = new iFixitDevice( data[i].topic, sortable );
						d.appendToList( 'device-list' );
					}
				}
			}
		});
	
		window.addEvent('domready', function() {
			sortable = new Sortables('ul', {
				clone: true,
				revert: true,
				opacity: 0.7,
				onStart: function( element, clone ) {
					this.parent = element.getParent();
				},
				onComplete: function( element ) {
					var p = element.getParent();
				
					if( p !== this.parent )
					{
						if( p.get('id') === 'gear-list' )
							db.insert( element.get('name'), element.get('src') );
						else if( p.get('id') === 'device-list' )
							db.delete( element.get('name') );
					}
				}
			});
			
			db.selectAll( function(length, rows) {
				for( i = 0; i < length; i++ )
				{
					gear.push( rows[i].name );
					var d = new iFixitDevice( rows[i].name, sortable );
					d.appendToList( 'gear-list' )
				}
			});
			
			deviceRequest.send();
			
			$('get-more').addEvent( 'click', function() {
				deviceRequest.options.data.offset += 10;
				deviceRequest.send();
			});
		});
	</script>
</head>
<body>
    <div id="devices">
		<h3>Devices</h3>
		<ul id="device-list"></ul>
		<button id="get-more">Get More</button>
    </div>
    <div id="middle">
    
    </div>
    <div id="gearbag">
		<h3>Gear Bag</h3>
		<ul id="gear-list"></ul>
    </div>
    <div style="clear: both;"></div>
</body>
</html>
